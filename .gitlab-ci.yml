# Simple GitLab CI/CD Pipeline for Laravel 11 Project
# Build dependencies and run tests

# Define the stages
stages:
  - build
  - test

# Variables used across all jobs
variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: laravel_test
  MYSQL_USER: laravel
  MYSQL_PASSWORD: laravel
  DB_HOST: mysql
  DB_DATABASE: laravel_test
  DB_USERNAME: laravel
  DB_PASSWORD: laravel

# Cache configuration for faster builds
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - vendor/
    - .composer-cache/

# Build Stage - Install dependencies and prepare environment
build:
  image: php:8.2-cli
  stage: build
  before_script:
    # Install system dependencies
    - apt-get update -qq && apt-get install -y -qq git curl libmcrypt-dev libjpeg-dev libpng-dev libfreetype6-dev libbz2-dev libzip-dev unzip
    
    # Install PHP extensions
    - docker-php-ext-install pdo_mysql zip bcmath gd
    
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    
    # Set Composer cache directory
    - export COMPOSER_CACHE_DIR=.composer-cache
  script:
    # Install dependencies
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader
    
    # Set up Laravel environment
    - cp .env.example .env
    - php artisan key:generate --ansi
    
    # Create testing environment file
    - |
      cat > .env.testing << EOF
      APP_NAME=Laravel
      APP_ENV=testing
      APP_KEY=$(php artisan --no-ansi key:generate --show)
      APP_DEBUG=true
      APP_URL=http://localhost
      
      DB_CONNECTION=mysql
      DB_HOST=${DB_HOST}
      DB_PORT=3306
      DB_DATABASE=${DB_DATABASE}
      DB_USERNAME=${DB_USERNAME}
      DB_PASSWORD=${DB_PASSWORD}
      
      CACHE_DRIVER=array
      SESSION_DRIVER=array
      QUEUE_CONNECTION=sync
      MAIL_MAILER=array
      EOF
    
    - echo "Build completed successfully"
  artifacts:
    paths:
      - vendor/
      - .env
      - .env.testing
    expire_in: 1 hour

# Test Stage - Run all tests
test:
  image: php:8.2-cli
  stage: test
  services:
    - mysql:8.0
  dependencies:
    - build
  before_script:
    # Install system dependencies
    - apt-get update -qq && apt-get install -y -qq git curl libmcrypt-dev libjpeg-dev libpng-dev libfreetype6-dev libbz2-dev libzip-dev unzip mysql-client
    
    # Install PHP extensions
    - docker-php-ext-install pdo_mysql zip bcmath gd
  script:
    # Wait for MySQL to be ready
    - until mysql -h mysql -u $DB_USERNAME -p$DB_PASSWORD -e "SELECT 1"; do sleep 1; done
    
    # Clear caches
    - php artisan config:clear --env=testing
    - php artisan cache:clear --env=testing
    
    # Run database migrations
    - php artisan migrate --force --env=testing
    
    # Run all tests
    - vendor/bin/phpunit --testdox